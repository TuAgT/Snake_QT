name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ env.VERSION }}

    steps:
    - name: Get Version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref }}
        name: Release v${{ env.VERSION }}
        draft: false
        prerelease: false
        body: |
          ## 版本 v${{ env.VERSION }}
          
          此版本包含以下更新：
          - 贪吃蛇游戏完整功能
          - Qt6 框架开发
          - CMake 构建系统
          - 跨平台支持

  build-and-upload:
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install Qt (Ubuntu)
      if: runner.os == 'Linux'
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        dir: '${{ github.workspace }}/qt'

    - name: Install Qt (Windows)
      if: runner.os == 'Windows'
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        dir: '${{ github.workspace }}/qt'

    - name: Install Qt (macOS)
      if: runner.os == 'macOS'
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
        dir: '${{ github.workspace }}/qt'

    - name: Configure CMake
      run: cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build ${{ github.workspace }}/build --config Release

    - name: Package and Upload Assets (Linux)
      if: runner.os == 'Linux'
      run: |
        cd ${{ github.workspace }}/build
        tar -czf SnakeGame-Linux-${{ needs.create-release.outputs.version }}.tar.gz QTGuiDemo
        gh release upload v${{ needs.create-release.outputs.version }} SnakeGame-Linux-${{ needs.create-release.outputs.version }}.tar.gz
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Package and Upload Assets (Windows)
      if: runner.os == 'Windows'
      run: |
        Compress-Archive -Path "${{ github.workspace }}\build\Release\QTGuiDemo.exe" -DestinationPath "SnakeGame-Windows-${{ needs.create-release.outputs.version }}.zip"
        gh release upload v${{ needs.create-release.outputs.version }} SnakeGame-Windows-${{ needs.create-release.outputs.version }}.zip
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Package and Upload Assets (macOS)
      if: runner.os == 'macOS'
      run: |
        cd ${{ github.workspace }}/build
        tar -czf SnakeGame-macOS-${{ needs.create-release.outputs.version }}.tar.gz QTGuiDemo
        gh release upload v${{ needs.create-release.outputs.version }} SnakeGame-macOS-${{ needs.create-release.outputs.version }}.tar.gz
      env:
        GH_TOKEN: ${{ github.token }}